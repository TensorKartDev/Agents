name: firmware-penetration-workflow
description: Multi-phase agent orchestration for firmware reverse engineering and pentesting.
defaults:
  llm_provider: agx.llm.provider:OllamaProvider
  llm_params:
    model: llama3.2
    host: http://localhost:11434

agents:
  firmware_agent:
    description: Executes the bare-metal/RTOS firmware workflow from intake to verification.
    tools:
      - firmware_directory_list
      - firmware_entropy_check
      - firmware_intake
      - firmware_os_identifier
      - firmware_hex_to_bin
      - firmware_key_finder
      - verification_planner
    planning:
      max_iterations: 4

# Workflow aligned to the provided bash-command flow map.
tasks:
  - id: firmware-intake
    type: human_input
    agent: firmware_agent
    description: Enter firmware working directory and firmware file path.
    ui:
      title: Firmware workflow intake
      description: Provide local paths used in the firmware penetration workflow.
      fields:
        - id: firmware_dir
          label: Firmware working directory
          kind: path
          required: true
        - id: firmware_path
          label: Firmware image (.hex/.bin)
          kind: path
          required: true

  - id: 01-add-firmware
    type: tool_run
    tool: firmware_directory_list
    agent: firmware_agent
    description: Enter directory and list files (cd, ls).
    depends_on: [firmware-intake]
    input:
      path: "{{inputs.firmware-intake.firmware_dir}}"

  - id: 02-entropy-check
    type: tool_run
    tool: firmware_entropy_check
    agent: firmware_agent
    description: Check firmware entropy range and compression/encryption likelihood.
    depends_on: [01-add-firmware]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      timeout: 300

  - id: 03-extract-firmware
    type: tool_run
    tool: firmware_intake
    agent: firmware_agent
    description: Extract firmware with binwalk (-e) for downstream OS and magic checks.
    depends_on: [02-entropy-check]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      extract: true
      output_dir: ./artifacts/firmware_extract

  - id: 03-fw-ident
    type: tool_run
    tool: firmware_os_identifier
    agent: firmware_agent
    description: Check OS family (Bare metal/RTOS/Linux/Other), hexdump, and ARM magic heuristic.
    depends_on: [03-extract-firmware]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      timeout: 180

  - id: 04-hex2bin
    type: tool_run
    tool: firmware_hex_to_bin
    agent: firmware_agent
    description: Optional conversion from extracted hex to binary using objcopy.
    depends_on: [03-fw-ident]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      output_path: ./artifacts/firmware_extract/Firmex.bin

  - id: 05-find-key
    type: tool_run
    tool: firmware_key_finder
    agent: firmware_agent
    description: Run strings and grep-like key/password discovery from firmware binary/text.
    depends_on: [04-hex2bin]
    input:
      path: ./artifacts/firmware_extract/Firmex.bin
      output_txt: ./artifacts/firmware_extract/save.txt
      min_len: 6
      pattern: "(?i)(key|password|passwd|token|secret|private)"

  - id: ghidra-handoff
    agent: firmware_agent
    description: Produce analyst handoff checklist for opening firmware binary in Ghidra.
    depends_on: [05-find-key]
    input:
      findings:
        - Entropy profile reviewed
        - OS and ARM magic heuristic checked
        - strings output and key hits saved to save.txt
        - Firmex.bin prepared for reverse engineering

tools:
  firmware_directory_list:
    type: agx.tools.builtin:FirmwareDirectoryListTool
  firmware_entropy_check:
    type: agx.tools.builtin:FirmwareEntropyCheckTool
  firmware_intake:
    type: agx.tools.builtin:FirmwareIntakeTool
  firmware_os_identifier:
    type: agx.tools.builtin:FirmwareOsIdentifierTool
  firmware_hex_to_bin:
    type: agx.tools.builtin:FirmwareHexToBinTool
  firmware_key_finder:
    type: agx.tools.builtin:FirmwareKeyFinderTool
  verification_planner:
    type: agx.tools.builtin:VerificationPlannerTool
