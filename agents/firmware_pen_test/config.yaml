name: firmware-penetration-workflow
description: Multi-phase agent orchestration for firmware reverse engineering and pentesting.
defaults:
  llm_provider: agx.llm.provider:OllamaProvider
  llm_params:
    model: gpt-oss
    host: http://localhost:11434

agents:
  firmware_agent:
    description: Executes the bare-metal/RTOS firmware workflow from intake to verification.
    tools:
      - firmware_preflight
      - firmware_format_detector
      - firmware_prepare_binary
      - firmware_directory_list
      - firmware_entropy_check
      - firmware_extract
      - firmware_os_identifier
      - firmware_key_finder
      - verification_planner
    planning:
      max_iterations: 4

# Workflow aligned to the provided bash-command flow map.
tasks:
  - id: firmware-intake
    type: human_input
    agent: firmware_agent
    description: Enter firmware working directory and firmware file path.
    ui:
      title: Firmware workflow intake
      description: Provide local paths used in the firmware penetration workflow.
      fields:
        - id: firmware_dir
          label: Firmware working directory
          kind: path
          required: true
        - id: firmware_path
          label: Firmware image (.hex/.bin)
          kind: path
          required: true

  - id: 01-add-firmware
    type: tool_run
    tool: firmware_directory_list
    agent: firmware_agent
    description: Enter directory and list files (cd, ls).
    depends_on: [firmware-intake]
    input:
      path: "{{inputs.firmware-intake.firmware_dir}}"

  - id: 00-preflight
    type: tool_run
    tool: firmware_preflight
    agent: firmware_agent
    description: Validate dependencies, inputs, and create isolated workspace for this run.
    depends_on: [firmware-intake]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      required_tools:
        - file
        - binwalk
        - strings
        - grep
        - hexdump
      optional_tools:
        - objcopy
        - srec_cat

  - id: 01-format-detect
    type: tool_run
    tool: firmware_format_detector
    agent: firmware_agent
    description: Detect firmware format before branching to conversion/extraction.
    depends_on: [00-preflight]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"

  - id: 02-prepare-binary
    type: tool_run
    tool: firmware_prepare_binary
    agent: firmware_agent
    description: Convert Intel HEX to BIN (or reuse binary directly) before analysis.
    depends_on: [01-format-detect]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      detected_format: "{{results.01-format-detect.detected_format}}"
      workspace_dir: "{{results.00-preflight.workspace_dir}}"
      binary_path: "{{results.00-preflight.workspace_dir}}/prepared.bin"

  - id: 03-entropy-check
    type: tool_run
    tool: firmware_entropy_check
    agent: firmware_agent
    description: Check entropy on prepared binary artifact.
    depends_on: [02-prepare-binary]
    input:
      path: "{{results.02-prepare-binary.binary_path}}"
      timeout: 300

  - id: 04-extract-firmware
    type: tool_run
    tool: firmware_extract
    agent: firmware_agent
    description: Extract firmware in isolated workspace using binwalk.
    depends_on: [03-entropy-check]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      output_dir: "{{results.00-preflight.workspace_dir}}/extract"
      timeout: 300

  - id: 05-fw-ident
    type: tool_run
    tool: firmware_os_identifier
    agent: firmware_agent
    description: Check OS family and ARM magic heuristic on prepared binary.
    depends_on: [04-extract-firmware]
    input:
      path: "{{inputs.firmware-intake.firmware_path}}"
      extracted_path: "{{results.02-prepare-binary.binary_path}}"
      timeout: 180

  - id: 06-find-key
    type: tool_run
    tool: firmware_key_finder
    agent: firmware_agent
    description: Run strings and key discovery on prepared binary.
    depends_on: [05-fw-ident]
    input:
      path: "{{results.02-prepare-binary.binary_path}}"
      output_txt: "{{results.00-preflight.workspace_dir}}/save.txt"
      min_len: 6
      grep_term: Key

  - id: ghidra-handoff
    type: tool_run
    tool: firmware_ghidra_handoff
    agent: firmware_agent
    description: Produce analyst handoff checklist for opening firmware binary in Ghidra.
    depends_on: [06-find-key]
    input:
      binary_path: "{{results.02-prepare-binary.binary_path}}"
      strings_txt: "{{results.06-find-key.output_txt}}"
      project_dir: "{{results.00-preflight.workspace_dir}}/ghidra_project"
      project_name: firmware_review
      findings:
        - Entropy profile reviewed
        - OS and ARM magic heuristic checked
        - strings output and key hits saved to save.txt
        - Prepared binary ready for reverse engineering

tools:
  firmware_preflight:
    type: agx.tools.builtin:FirmwarePreflightTool
  firmware_format_detector:
    type: agx.tools.builtin:FirmwareFormatDetectorTool
  firmware_prepare_binary:
    type: agx.tools.builtin:FirmwarePrepareBinaryTool
  firmware_directory_list:
    type: agx.tools.builtin:FirmwareDirectoryListTool
  firmware_entropy_check:
    type: agx.tools.builtin:FirmwareEntropyCheckTool
  firmware_extract:
    type: agx.tools.builtin:FirmwareExtractTool
  firmware_os_identifier:
    type: agx.tools.builtin:FirmwareOsIdentifierTool
  firmware_key_finder:
    type: agx.tools.builtin:FirmwareKeyFinderTool
  firmware_ghidra_handoff:
    type: agx.tools.builtin:FirmwareGhidraHandoffTool
  verification_planner:
    type: agx.tools.builtin:VerificationPlannerTool
